{
  "name": "Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "source_added",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -128,
        -80
      ],
      "id": "ac70b88f-a6df-40ef-87d7-a5212e032ec4",
      "name": "Webhook",
      "webhookId": "2df1295c-7e18-42b3-a6e6-ae0575f2e5e0"
    },
    {
      "parameters": {
        "jsCode": "// Code node — v2 sözdizimi (en garanti yol)\n\n// 1) Girdiyi al\nconst raw = $input.first().json;\n\n// 2) Webhook'un gerçek payload'unu çıkar (body'de ya da kökte olabilir)\nlet p = raw?.body ?? raw;\nif (typeof p === 'string') { try { p = JSON.parse(p); } catch {} }\n\n// 3) rss_url ve city_name'i olası tüm yerlerden topla\nconst rss =\n  p?.rss_url ??\n  p?.rss ??\n  p?.url ??\n  p?.source?.rss_url ??\n  p?.source?.rss ??\n  p?.source?.url ??\n  null;\n\nconst city =\n  p?.city_name ??\n  p?.province ??\n  p?.city ??\n  p?.source?.city_name ??\n  p?.source?.province ??\n  p?.source?.city ??\n  '';\n\n// 4) Çıkış (Code node'da JSON payload böyle döndürülür)\nreturn [\n  {\n    json: {\n      skip: !rss,                   // rss yoksa true olur\n      rss_url: rss || '',\n      city_name: city || '',\n      debug: { raw, parsed: p, rss, city }\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -80
      ],
      "id": "36311068-5368-4d95-9164-43937f0bf089",
      "name": "Code (Extract Source)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e760b107-e74b-463a-9b49-2067e62cc713",
              "leftValue": "={{$json[\"skip\"]}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        272,
        -80
      ],
      "id": "a3ade4ae-1ca3-4430-8a64-1e9b6726801c",
      "name": "If (skip)"
    },
    {
      "parameters": {
        "url": "={{$json[\"rss_url\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        512,
        -48
      ],
      "id": "a5ff9a79-a759-4f66-95a7-9f0cd43de65b",
      "name": "RSS Read"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        688,
        -48
      ],
      "id": "f83955d2-1656-4dd4-ac0b-9ef8a55cf8b0",
      "name": "Limit"
    },
    {
      "parameters": {
        "jsCode": "const i = $json;\nconst title = i.title || i['content:encodedSnippet'] || 'Başlık yok';\nconst url   = i.link || i.url || '';\nconst summary = i.contentSnippet || i.description || i.content || '';\nconst iso = i.isoDate || i.pubDate || null;\n\nfunction canonical(u){\n  try { const uu = new URL(u); uu.hash=''; return uu.toString(); }\n  catch { return u; }\n}\n\nreturn [{\n  json: {\n    title,\n    url: canonical(url),\n    summary: String(summary).trim().slice(0, 600),\n    publishedAt: iso || null\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        -48
      ],
      "id": "7813e46d-92aa-45ad-9880-84de412bd742",
      "name": "Code (Prepare Item)"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1008,
        -48
      ],
      "id": "429211c7-c2e3-4233-b19e-5248a26a384b",
      "name": "Wait1",
      "webhookId": "3b7d6585-bdb0-431d-b11f-dc5314e341d5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        1056,
        112
      ],
      "id": "2ca7808e-011b-42c4-8609-333da7784253",
      "name": "When chat message received",
      "webhookId": "a451577e-0ff8-4840-ac97-376795ea169f"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Aşağıda verilen haber metninden hareket et. Bir vatandaş yazıyormuş gibi, kısa ve doğal bir\nmesaja (tweet tarzı) dönüştür. Ardından kategoriyi seç ve 3 etiket öner.\n\nBaşlık: {{$json.title}}\nÖzet: {{$json.summary}}\nBağlantı: {{$json.url}}\nİl: {{$node[\"Code (Extract Source)\"].json[\"city_name\"] || \"Sivas\"}}\nYayın zamanı (ISO, boş olabilir): {{$json.publishedAt || \"\"}}\n\nKurallar:\n1) category SADECE şu dörtlüden biri olsun (küçük harf): [\"şikayet\",\"soru\",\"öneri\",\"istek\"].\n2) tweetText: 200 karakteri geçmesin, doğal ve insani dille yaz. Hashtag VE emoji kullanma.\n3) tags: 2–3 öğe, tamamen küçük harf, boşluk ve # işareti yok. (örn: \"ulasim\",\"altyapi\",\"sehir\")\n4) Geçerli JSON dışında hiçbir şey yazma; kod bloğu, açıklama, yorum yok.\n5) JSON alanlarını eksiksiz doldur. Metinlerde çift tırnakları gerektiği gibi escape et.\n\nSADECE ŞU JSON’U DÖNDÜR (başka metin yok):\n{\n  \"source\": \"rss\",\n  \"province\": \"{{$node[\"Code (Extract Source)\"].json[\"city_name\"] || \"Sivas\"}}\",\n  \"title\": \"{{$json.title}}\",\n  \"url\": \"{{$json.url}}\",\n  \"category\": \"<şikayet|soru|öneri|istek>\",\n  \"tags\": [\"<tag1>\",\"<tag2>\"],\n  \"summary\": \"{{$json.summary}}\",\n  \"publishedAt\": \"{{$json.publishedAt || \"\"}}\",\n  \"tweetText\": \"<200 karakterlik vatandaş mesajı, hashtag yok>\"\n}\n",
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1232,
        -48
      ],
      "id": "0c9c84ba-cc38-40fc-bbd7-2872efb535ea",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1232,
        112
      ],
      "id": "865fddee-b730-4e1f-8429-801a63c3ac15",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "jsCode": "const raw = $json.text ?? $json.completion ?? JSON.stringify($json);\nlet out;\ntry { out = JSON.parse(raw); } catch {\n  out = {\n    source:'rss',\n    province:$node[\"Code (Extract Source)\"].json[\"city_name\"]||'',\n    title:$node[\"Prepare Item\"].json[\"title\"],\n    url:$node[\"Prepare Item\"].json[\"url\"],\n    category:'öneri',\n    tags:[],\n    summary:$node[\"Prepare Item\"].json[\"summary\"],\n    publishedAt:$node[\"Prepare Item\"].json[\"publishedAt\"],\n    tweetText:''\n  };\n}\nconst ALLOWED=['şikayet','soru','öneri','istek'];\nif(!ALLOWED.includes(String(out.category||'').toLowerCase())) out.category='öneri';\nif(!Array.isArray(out.tags)) out.tags=[];\nout.tags=[...new Set(out.tags.map(t=>String(t||'').trim().toLowerCase()).filter(t=>t && t.length<=24))].slice(0,3);\nreturn [{ json: out }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        -48
      ],
      "id": "9a377636-11cd-4ab6-9ec1-46ece094e387",
      "name": "Code (parse)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.BASE_URL }}/api/news",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-api-key",
              "value": "={{ $vars.API_KEY}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "source",
              "value": "={{ $json.source }}"
            },
            {
              "name": "province",
              "value": "={{ $json.province }}"
            },
            {
              "name": "title",
              "value": "={{ $json.title }}"
            },
            {
              "name": "url",
              "value": "={{ $json.url }}"
            },
            {
              "name": "category",
              "value": "={{ $json.category }}"
            },
            {
              "name": "tags",
              "value": "={{ $json.tags }}"
            },
            {
              "name": "summary",
              "value": "={{ $json.summary }}"
            },
            {
              "name": "publishedAt",
              "value": "={{ $json.publishedAt }}"
            },
            {
              "name": "tweetText",
              "value": "={{ $json.tweetText }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1664,
        -48
      ],
      "id": "bd61294b-6b8a-4a38-b9e4-1688feb96035",
      "name": "HTTP Request POST"
    },
    {
      "parameters": {
        "url": "={{ $vars.BASE_URL }}/api/news",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $vars.API_KEY }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {
              "maxRedirects": 5
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1824,
        -48
      ],
      "id": "63644276-c1fb-47ae-904c-8e9a81f6b549",
      "name": "HTTP Request GET"
    }
  ],
  "connections": {
    "Code (Extract Source)": {
      "main": [
        [
          {
            "node": "If (skip)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If (skip)": {
      "main": [
        [],
        [
          {
            "node": "RSS Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSS Read": {
      "main": [
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit": {
      "main": [
        [
          {
            "node": "Code (Prepare Item)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Prepare Item)": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Code (parse)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code (parse)": {
      "main": [
        [
          {
            "node": "HTTP Request POST",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request POST": {
      "main": [
        [
          {
            "node": "HTTP Request GET",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code (Extract Source)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 0,
  "meta": null
}